# Hystrix

Hystrix是一个用于处理分布式系统的延迟和容错的开源库，在分布式系统里，许多依赖不可避免的会调用失败，比如超时、异常等，Hystrix能够保证在一个依赖出问题的情况下，不会导致整体服务失败，避免级联故障，以提高分布式系统的弹性。

## 服务降级 

向调用方返回一个符合预期的、可处理的备选响应（FallBack）。

服务器忙，请稍后再试，不让客户端等待并立刻返回一个友好提示。

#### 哪些情况会触发降级

- 程序运行异常

- 超时

- 服务熔断触发服务降级

- 线程池/信号量打满也会导致服务降级

#### @HystrixCommand报异常后如何处理

一旦调用服务方法失败并跑出了错误信息后，会自动调用@HystrixCommand标注好的fallbackMethod调用类中的指定方法



@EnableHystrix 和 @@EnableCircuitBreaker这两者这件有何不同？

feign ribbon Hystrix整合配置详解

https://www.cnblogs.com/crazymakercircle/p/11664812.html



触发降级的超时配置

默认为1000ms，同时配置了多个超时时间时（注解+yml），以小的为准




## 服务熔断

类比保险丝，达到最大服务访问后，直接拒绝访问，调用服务降级方法并返回友好提示

##### 熔断机制概述

熔断机制是应对雪崩效应的一种微服务链路保护机制。当扇出链路的某个微服务出错不可用或者响应时间太长时，会进行服务的降级，进而熔断该节点微服务的调用，快速返回错误的响应信息。

当检测到该节点微服务调用响应正常后，恢复调用链路。

在Spring Cloud框架里，熔断机制通过Hystrix实现。Hystrix会监控微服务间调用的状况，当失败的调用到一定阈值（缺省是5秒内20次调用失败），就会启动熔断机制。熔断机制的注解是@HystrixCommand。



#### 熔断类型

熔断打开：请求不在进行调用当前服务，内部设置时钟一般为MTTR（平均故障处理时间），当打开时长打到所设时钟则进入半熔断状态。

熔断半开：部分请求根据规则调用当前服务，如果请求成功且符合规则则认为当前服务恢复正常，关闭熔断。

#### 断路器涉及到的三个重要参数

1. 快照时间窗：断路器确定是否打开需要统计一些请求和错误数据，而统计的时间范围就是快照时间窗，默认为最近的10秒。

2. 请求总数阈值：在快照时间窗内，必须满足请求总数阈值才有资格熔断。默认为20，意味着在这10秒内，如果该hystrix命令的调用次数不足20次，即使所有的请求都超时或其他原因失败，断路器都不会打开。

3. 错误百分比阈值：当请求宗师在快照时间窗内超过了阈值，比如发生了30次调用，如果在这30次调用中，有15次发生了超时异常，也就是超过50%的错误百分比，在默认设定50%阈值情况下，这时候就会将断路器打开。

#### 断路器开启、关闭的条件

1. 当满足一定的阈值的时候（默认10秒内超过20个请求次数）。
2. 当失败率达到一定的时候（默认10秒内超过50%的请求失败）。
3. 到达以上阈值，断路器将会开启。
4. 当开启的时候，所有请求都不会进行转发。
5. 一段时间之后（默认是5秒），这个时候断路器是半开状态，会让其中一个请求进行转发。如果成功，断路器会关闭，若失败，继续开启。

#### 断路器打开以后

再用请求调用的时候，将不会调用主逻辑，而是直接调用降级fallback。通过断路器，实现了自发地发现错误并将降级逻辑切换为主逻辑，减少响应延迟的效果。

##### 原来的主逻辑要如何恢复呢？

hystrix实现了自动恢复功能。

当断路器打开，对主逻辑进行熔断之后，hystrix会启动一个休眠时间窗，降级逻辑是临时成为主逻辑，当休眠时间窗到期，断路器将进入半开状态，释放一次请求到原来的主逻辑上，如果此次请求正常返回，那么断路器将继续闭合，主逻辑恢复，如果这次请求依然有问题，断路器继续进行打开状态，休眠时间窗重新计时。




## 服务限流

秒杀、高并发等操作，严禁一窝蜂的过来拥挤，大家排队，一秒钟N个，有序进行